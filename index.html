import React, { useState, useEffect, useRef } from 'react';
import axios from 'axios';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged } from 'firebase/auth';
import './ShortVideos.css';

// Firebase कॉन्फिगरेशन
const firebaseConfig = {
  apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const ShortVideos = () => {
  const [user, setUser] = useState(null);
  const [videoFile, setVideoFile] = useState(null);
  const [backgroundImage, setBackgroundImage] = useState(null);
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [videos, setVideos] = useState([]);
  const [videoSpeed, setVideoSpeed] = useState(1); // डिफॉल्ट स्पीड 1x
  const videoRef = useRef(null);
  const lastTap = useRef(0);

  // यूजर ऑथेंटिकेशन और वीडियो फेच
  useEffect(() => {
    onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    fetchVideos();
  }, []);

  // वीडियो फेच करें
  const fetchVideos = async () => {
    try {
      const res = await axios.get('https://your-backend-url/api/videos');
      setVideos(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  // डबल-टैप लाइक हैंडलर
  const handleDoubleTap = async (videoId) => {
    const now = Date.now();
    const DOUBLE_TAP_DELAY = 300; // 300ms के अंदर दो टैप
    if (now - lastTap.current < DOUBLE_TAP_DELAY) {
      try {
        await axios.post(`https://your-backend-url/api/videos/${videoId}/like`, {
          userId: user.uid,
        });
        alert('Video liked!');
        fetchVideos(); // अपडेटेड लाइक काउंट के लिए रिफ्रेश
      } catch (err) {
        console.error(err);
        alert('Error liking video');
      }
    }
    lastTap.current = now;
  };

  // वीडियो अपलोड हैंडलर
  const handleUpload = async (e) => {
    e.preventDefault();
    if (!user) {
      alert('Please log in to upload videos');
      return;
    }
    const formData = new FormData();
    formData.append('video', videoFile);
    formData.append('backgroundImage', backgroundImage);
    formData.append('title', title);
    formData.append('description', description);
    formData.append('userId', user.uid);
    formData.append('speed', videoSpeed);

    try {
      const res = await axios.post('https://your-backend-url/api/videos/upload', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setVideos([...videos, res.data]);
      alert('Video uploaded successfully!');
    } catch (err) {
      console.error(err);
      alert('Error uploading video');
    }
  };

  // सोशल मीडिया शेयरिंग
  const shareVideo = (videoUrl) => {
    const shareUrl = encodeURIComponent(videoUrl);
    const shareText = encodeURIComponent('Check out this awesome video on ECShort!');
    window.open(`https://x.com/share?url=${shareUrl}&text=${shareText}`);
  };

  // PWA इंस्टॉल हैंडलर
  const [deferredPrompt, setDeferredPrompt] = useState(null);
  useEffect(() => {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      setDeferredPrompt(e);
    });
  }, []);

  const handleInstall = () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        setDeferredPrompt(null);
      });
    }
  };

  return (
    <div className="short-videos-container">
      <h1>ECShort Videos</h1>
      {deferredPrompt && (
        <button onClick={handleInstall} className="install-button">
          Install ECShort App
        </button>
      )}

      {/* वीडियो अपलोड और एडिटिंग फॉर्म */}
      {user ? (
        <form onSubmit={handleUpload}>
          <input
            type="text"
            placeholder="Video Title"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            required
          />
          <textarea
            placeholder="Description"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
          />
          <input type="file" accept="video/*" onChange={(e) => setVideoFile(e.target.files[0])} required />
          <input
            type="file"
            accept="image/*"
            onChange={(e) => setBackgroundImage(e.target.files[0])}
            placeholder="Upload Background Image"
          />
          <label>Video Speed:</label>
          <select value={videoSpeed} onChange={(e) => setVideoSpeed(e.target.value)}>
            <option value="0.5">0.5x</option>
            <option value="1">1x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
          </select>
          <button type="button" onClick={() => alert('AI Editing: Auto-captions and trimming coming soon!')}>
            Apply AI Editing
          </button>
          <button type="submit">Upload Video</button>
        </form>
      ) : (
        <p>Please log in to upload videos</p>
      )}

      {/* AdSense विज्ञापन */}
      <div className="adsense-container">
        <ins
          className="adsbygoogle"
          style={{ display: 'block' }}
          data-ad-client="ca-pub-your-adsense-id"
          data-ad-slot="your-ad-slot-id"
          data-ad-format="auto"
        ></ins>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>

      {/* वीडियो लिस्ट */}
      <div className="video-list">
        {videos.map((video) => (
          <div key={video._id} className="video-card">
            <video
              ref={videoRef}
              width="320"
              height="240"
              controls
              playbackRate={video.speed}
              onTouchStart={() => handleDoubleTap(video._id)}
              style={{ backgroundImage: `url(${video.backgroundImage})`, backgroundSize: 'cover' }}
            >
              <source src={video.url} type="video/mp4" />
            </video>
            <h3>{video.title}</h3>
            <p>{video.description}</p>
            <div className="interactions">
              <button onClick={() => handleDoubleTap(video._id)}>Like ({video.likes.length})</button>
              <button onClick={() => alert('Comment feature coming soon!')}>Comment</button>
              <button onClick={() => shareVideo(video.url)}>Share</button>
              <button onClick={() => alert('Subscribe feature coming soon!')}>Subscribe</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default ShortVideos;
